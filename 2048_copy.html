<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <link rel="stylesheet" type = "text/css" href="css/2048.css">
    <meta http-equiv = "content-type" content = "text/html:charset=utf-8">
    <title>2048</title>
  </head>

  <body　align = "center">
    <header>
      情報ネットワーク特論
    </header>
    <canvas id="canvas" width="400" height="400">
    </canvas>
    <script>
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext('2d');
      var dis = [[0,0,0,0],[0,0,0,0],[0,0,2,0],[0,0,0,0]];
      var color = ["gray","rgb(240,248,255)","rgb(224,255,255)","rgb(175,238,238)","rgb(135,206,235)","rgb(0,191,255)","cyan","rgb(64,224,208)","rgb(72,209,204)","rgb(60,179,113)","rgb(34,139,34)"];
      function display(){
        console.log(dis);
        for(var j=0;j<4;j++)
        for(var i=0;i<4;i++)
        {
          if(dis[i][j] != 0){
          ctx.fillStyle = color[Math.log2(dis[i][j])];
        }
          else{
          ctx.fillStyle = "rgb(230,230,230)";
          }
          ctx.fillRect(i * 100 + 2, j * 100 + 2, 96, 96);
          if(dis[i][j] != 0){
            //<!-- フォントの変更ならここ -->
            ctx.font ="20px Comic Sans MS";
            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.fillText(dis[i][j], i*100+50,j*100+60);
          }

        }
      }
      function right(){
        for(var i = 0; i < 4; i++){
          var ar = [0,0,0,0];
          var vr = [];
          for(var j=0;j<4;j++){
            if(dis[j][i] != 0)
            vr.push(dis[j][i]);
            ar[j] = dis[j][i];
          }
        //<!-- reverse the vr -->
          var tr = [];
          for(var k =vr.length - 1; k>=0;k--){
            tr.push(vr[k]);
          }
          for(var k=0;k<vr.length;k++)
          vr[k] = tr[k];

          var l = vr.length;
          if(l>1){
            if(l==2){
              if(vr[0]==vr[1]){
                vr[0] = 2*vr[0];
                vr[1] = 0;
              }
            }
            else if(l==3){
              if(vr[0]==vr[1]){
                vr[0] = 2*vr[0];
                vr[1] = vr[2];
                vr[2] = 0;
              }
              else if(vr[1] ==vr[2]){
                vr[1]=2*vr[1];
                vr[2]=0;
              }
            }
            else{
              if(vr[0] == vr[1]){
                if(vr[2]==vr[3]){
                  vr[0] = 2*vr[0];
                  vr[1] = 2*vr[2];
                  vr[2]=0;
                  vr[3]=0;
                }
                else{
                  vr[0] = 2*vr[0];
                  vr[1] = vr[2];
                  vr[2] = vr[3];
                  vr[3] = 0;
                }
              }
              else if(vr[1] == vr[2]){
                vr[1] = 2*vr[2];
                vr[2] = vr[3];
                vr[3] = 0;
              }
              else if(vr[2] == vr[3]){
                vr[3] = 2*vr[2];
                vr[3] = 0;
              }
            }
          }
          for(var k = 0;k<4-l;k++)
          vr.push(0);
          tr = [];
          for(var k = vr.length - 1; k >= 0; k--){
            tr.push(vr[k]);
          }
          for(var k=0;k<vr.length; k++)
          vr[k] = tr[k];
          for(var k = 0; k < 4; k++)
          dis[k][i] = vr[k];
        }
      }
      function down(){
        for(var i = 0; i < 4; i++){
          var ar = [0,0,0,0];
          var vr = [];
          for(var j = 0; j < 4; j++){
            if(dis[i][j] != 0)
            vr.push(dis[i][j]);
            ar[j] = dis[i][j];
          }
          var tr = [];
          for(var k = vr.length-1; k >=0; k--){
            tr.push(vr[k]);
          }
          for(var k = 0; k < vr.length; k++)
          vr[k] = tr[k];



          var l = vr.length;
          if(l > 1){
            if(l == 2){
              if(vr[0] == vr[1]){
                vr[0] = 2 * vr[0];
                vr[1] = 0;
              }
            }
            else if(l == 3){
              if(vr[0] == vr[1]){
                vr[0] = 2*vr[0];
                vr[1] = vr[2];
                vr[2] = 0;
              }
              else if(vr[1] == vr[2]){
                vr[1] = 2* vr[1];
                vr[2] = 0;
              }
            }
            else{
              if(vr[0] == vr[1]){
                if(vr[2] == vr[3]){
                  vr[0] = 2*vr[0];
                  vr[1] = 2*vr[2];
                  vr[2] = 0;
                  vr[3] = 0;
                }

                else{
                  vr[0] = 2*vr[0];
                  vr[1] = vr[2];
                  vr[2] = vr[3];
                  vr[3] = 0;
                }
              }
              else if(vr[1] == vr[2]){
              vr[1] = 2*vr[2];
              vr[2] = vr[3];
              vr[3] = 0;
            }
            else if(vr[2] == vr[3]){
              vr[2] = 2*vr[2];
              vr[3] = 0;
            }

          }
        }
        for(var k = 0; k < 4 - l; k++)
        vr.push(0);
        tr = [];
        for(var k = vr.length -1; k>= 0; k--){
          tr.push(vr[k]);
        }
        for(var k = 0; k < vr.length; k++)
        vr[k] = tr[k];

        for(var k = 0; k < 4; k++)
        dis[i][k] = vr[k];
      }
    }
    function up(){
      for(var i = 0; i < 4; i++){
        var ar = [0,0,0,0];
        var vr = [];
        for(var j = 0; j < 4; j++){
          if(dis[i][j] != 0)
          vr.push(dis[i][j]);
          ar[j] = dis[i][j];
        }


        var l = vr.length;
        if(l > 1){
          if(l == 2){
            if(vr[0] == vr[1]){
              vr[0] = 2*vr[0];
              vr[1] = 0;
            }
          }
          else if(l == 3){
            if(vr[0] == vr[1]){
              vr[0] = 2*vr[0];
              vr[1] = vr[2];
              vr[2] = 0;
            }
            else if(vr[1] == vr[2]){
              vr[1] = 2*vr[1];
              vr[2] = 0;
            }
          }
          else{
            if(vr[0] == vr[1]){
              if(vr[2] == vr[3]){
                vr[0] = 2*vr[0];
                vr[1] = 2*vr[2];
                vr[2] = 0;
                vr[3] = 0;
              }
              else{
                vr[0] = 2*vr[0];
                vr[1] = vr[2];
                vr[2] = vr[3];
                vr[3] = 0;
              }
            }
            else if(vr[1] == vr[2]){
              vr[1] = 2*vr[2];
              vr[2] = vr[3];
              vr[3] = 0;
            }
            else if(vr[2] == vr[3]){
              vr[2] = 2*vr[3];
              vr[3] = 0;
            }
          }
        }
        for(var k = 0; k < 4-l; k++)
        vr.push(0);
        for(var k = 0; k < 4; k++)
        dis[i][k] = vr[k];
      }
    }
    function left(){
      for(var i = 0; i < 4; i++){
        var ar = [0,0,0,0];
        var vr = [];
        for(var j = 0; j < 4; j++){
          if(dis[j][i] != 0)
          vr.push(dis[j][i]);
          ar[j] = dis[j][i];
        }
        var l = vr.length;
        if(l > 1){
          if(l == 2){
            if(vr[0] == vr[1]){
              vr[0] = 2*vr[0];
              vr[1] = 0;
            }
          }
          else if(l == 3){
            if(vr[0] == vr[1]){
              vr[0] = 2*vr[0];
              vr[1] = vr[2];
              vr[2] = 0;
            }
            else if(vr[1] == vr[2]){
              vr[1] = 2*vr[1];
              vr[2] = 0;
            }
          }
          else{
            if(vr[0] == vr[1]){
              if(vr[2] == vr[3]){
                vr[0] = 2*vr[0];
                vr[1] = 2*vr[2];
                vr[2] = 0;
                vr[3] = 0;
              }
              else{
                vr[0] = 2*vr[0];
                vr[1] = vr[2];
                vr[2] = vr[3];
                vr[3] = 0;
              }
            }
            else if(vr[1] == vr[2]){
              vr[1] = 2*vr[2];
              vr[2] = vr[3];
              vr[3] = 0;
            }
            else if(vr[2] == vr[3]){
              vr[2] = 2*vr[2];
              vr[3] = 0;
            }
          }
        }
        for(var k = 0; k < 4-l; k++)
        vr.push(0)
        for(var k = 0; k < 4; k++)
        dis[k][i] = vr[k];
      }
    }
    display();

    var disable = 0;
    function gameover(){
     ctx.font ="50px Comic Sans MS";
     ctx.fillStyle = "red";
     ctx.textAlign = "center";
     ctx.fillText("GAME OVER!!", 200, 180);
     disable = 1;
     ctx.fillStyle = "green";
     ctx.textAlign = "center";
     ctx.font = "30px Comic Sans MS";
     // var audio = new Audio("chiisanaashiato.mp3");
     // audio.play();

     var count = 0;
     for(var i = 0; i < 4; i++)
     for(var j = 0; j < 4; j++){
       count += dis[i][j];
     }
    ctx.fillText("Your Score is " + count.toString(),200,220);
    document.getElementById('score').value=count.toString();

    ctx.fillStyle = "black";
    ctx.textAlign = "center";
    ctx.font = "20px Comic Sans MS";
    ctx.fillText("ランキング登録もよろしくお願いします",200,240);



    }

    window.addEventListener("keydown",function(e){
      if(disable == 1)
      return;
     var audio = new Audio("cursor4.mp3");

     audio.play();
     key = e.keyCode;
     if(key == 37){
       e.preventDefault();
       left();
     }
     if(key == 38){
       e.preventDefault();
       up();
     }
     if(key == 39){
       e.preventDefault();
       right();
     }
     if(key == 40){
       e.preventDefault();
       down();
     }
     var count = 0;
     for(var i = 0; i < 4; i++)
     for(var j = 0; j < 4; j++){
       if(dis[i][j] == 0){
         count ++;
       }
     }
     if(count == 0){
       gameover();
       setTimeout(function(){var timer = 1;
         if(timer == 1){
           disp();
         }
       },3000);
       return;
     }
     else{
       if(key == 37 || key == 38 || key == 39 || key ==40){
         var n = Math.floor(Math.random()*16);
         for(;n < 32; n++){
           m = n % 16;
           if(dis[Math.floor(m/4)][m%4]==0){
             dis[Math.floor(m/4)][m%4] = 2;
             break;
         }
         }
       }
     }
     /*else{
     var v = Math.floor(Math.random()*16);
     count = 0;
     while(1){
       count++;
       if(dis[Math.floor(v/4)][v%4]==0){
         dis[Math.floor(v/4)][v%4] = 2;
         break;
       }
     }
     if(count == 5){
       for(var m = 0; m < 4; n++)
       if(dis[m][n]==0)
       dis[m][n] = 2;
     }
   }
 }*/
 display();
  });
  function disp(){
	// 「OK」時の処理開始 ＋ 確認ダイアログの表示
	if(window.confirm('ランキングを登録しますか')){
		location.href = "register.php";// example_confirm.html へジャンプ
	}
	// 「OK」時の処理終了
	// 「キャンセル」時の処理開始
	else{
		window.alert('引き続きゲームをお楽しみください'); // 警告ダイアログを表示
	}
}
    </script>
    <form method="post" action="register.php">
      <input type="hidden" name="game_score" id = "score">
    </form>

    <br>
    <br>
    <input class = "button_set "type="button" value = "リセット" onclick="location.reload()">
    <input class = "button_set" type="button" name = "ranking" value="ランキング" onclick="location.href='ranking.html'">
    <div class="push"></div>
    <footer>
      Copyright 2019
    </footer>
  </body>
</html>
